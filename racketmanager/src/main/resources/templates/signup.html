<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>会員登録</title>
  <link rel="stylesheet" href="/css/common-auth.css">

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <img src="/css/images/bones.jpg" alt="bones ロゴ" class="logo">
</header>

<h2>会員登録</h2>

<form th:action="@{/signup}" method="post" th:object="${user}">
  <div>
    <label>ユーザー名</label>
    <input type="text" th:field="*{username}" autocomplete="username" required>
  </div>

  <div>
    <label>パスワード</label>
    <input type="password" th:field="*{password}" autocomplete="new-password" required>
  </div>

  <!-- ✅ LINE連携情報（hidden） -->
  <input type="hidden" name="lineUserId" id="lineUserId">

  <!-- ✅ LINE連携ボタン -->
  <button type="button" id="lineLinkBtn" class="link-btn line-btn">
    LINE連携する
  </button>

  <!-- 状態表示 -->
  <div id="lineStatus" style="margin-top:10px; font-size:14px;"></div>

  <button type="submit" id="submitBtn" disabled>登録</button>
  <a th:href="@{/login}" class="link-btn">ログインページへ</a>
</form>

<script th:inline="javascript">
  const LIFF_ID = /*[[${liffId}]]*/ "";

  const lineUserIdInput = document.getElementById("lineUserId");
  const lineLinkBtn = document.getElementById("lineLinkBtn");
  const lineStatus = document.getElementById("lineStatus");
  const submitBtn = document.getElementById("submitBtn");

  function setLinked(userId){
    lineUserIdInput.value = userId;
    lineStatus.textContent = "✅ LINE連携済み";
    lineLinkBtn.textContent = "LINE連携済み";
    lineLinkBtn.disabled = true;
    submitBtn.disabled = false;
  }

  // ✅ LIFFじゃないなら、LINE連携なしでも登録OKにする（事故防止）
  function enableSignupWithoutLiff(){
    lineStatus.textContent = "（通常ブラウザで開いています）LINE連携は後で行えます。";
    lineLinkBtn.style.display = "none";
    submitBtn.disabled = false;
  }

  async function initLiff(){
    try{
      // LIFF_ID が渡ってないなら通常ブラウザ扱い
      if(!LIFF_ID){
        enableSignupWithoutLiff();
        return;
      }

      await liff.init({ liffId: LIFF_ID });

      // liffが使えない（LIFF外）なら通常ブラウザ扱い
      if(typeof liff === "undefined"){
        enableSignupWithoutLiff();
        return;
      }

      // ✅ LIFF内なら連携必須：まずは登録ボタンを無効のまま
      submitBtn.disabled = true;

      if(!liff.isLoggedIn()){
        lineStatus.textContent = "LINEログインして連携してください";
        return;
      }

      const profile = await liff.getProfile();
      if(profile?.userId){
        setLinked(profile.userId);
      }else{
        lineStatus.textContent = "❌ LINEユーザーIDが取得できませんでした";
      }
    }catch(e){
      console.error(e);
      // エラー時は通常登録に落とす（ユーザー詰ませない）
      enableSignupWithoutLiff();
    }
  }

  async function linkLine(){
    try{
      if(!LIFF_ID){
        enableSignupWithoutLiff();
        return;
      }

      await liff.init({ liffId: LIFF_ID });

      if(!liff.isLoggedIn()){
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      if(profile?.userId){
        setLinked(profile.userId);
      }else{
        lineStatus.textContent = "❌ LINEユーザーIDが取得できませんでした";
      }
    }catch(e){
      console.error(e);
      enableSignupWithoutLiff();
    }
  }

  lineLinkBtn.addEventListener("click", linkLine);

  // 起動時
  initLiff();
</script>


</body>
</html>
