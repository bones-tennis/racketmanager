<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/side_menu.css">
  <script src="/js/side_menu.js" defer></script>
  <title>依頼編集</title>
  <link rel="stylesheet" href="/css/order_form.css">
</head>
<body>
	<div th:replace="side_menu :: sideMenu"></div>
  <h2>依頼編集</h2>

  <form th:action="@{|/staff/orders/${order.id}/update|}" method="post">
    <label>顧客名</label>
    <div class="search-wrapper">
      <!-- ✅ 顧客が削除されていても customerName を表示する -->
      <input type="text" id="customerSearch" placeholder="顧客名を検索..." 
             autocomplete="off" 
             th:value="${order.customer != null ? order.customer.displayName : order.customerName}">
      
      <!-- 選択したIDを送信（nullでも空文字でOK） -->
      <input type="hidden" name="customerId" id="selectedCustomerId"
             th:value="${order.customer != null ? order.customer.id : ''}">

      <!-- サジェストリスト -->
      <ul id="suggestList" class="suggest-list">
        <li th:each="c : ${customers}"
            th:data-id="${c.id}"
            th:text="${c.displayName}">
        </li>
      </ul>
    </div>

    <label>ガット名</label>
    <div class="input-wrapper">
      <input type="text" th:value="${order.stringType}" name="stringType" required>
    </div>

    <label>ガット素材</label>
    <div class="select-wrapper">
      <select name="stringMaterial" required>
        <option value="ナイロン" th:selected="${order.stringMaterial == 'ナイロン'}">ナイロン</option>
        <option value="ポリエステル" th:selected="${order.stringMaterial == 'ポリエステル'}">ポリエステル</option>
        <option value="ナチュラル" th:selected="${order.stringMaterial == 'ナチュラル'}">ナチュラル</option>
      </select>
    </div>

    <label>テンション（メイン）</label>
    <div class="input-wrapper">
      <input type="text" th:value="${order.tensionMain}" name="tensionMain" required>
    </div>

    <label>テンション（クロス）</label>
    <div class="input-wrapper">
      <input type="text" th:value="${order.tensionCross}" name="tensionCross" required>
    </div>

    <label>金額（円）</label>
    <div class="input-wrapper">
      <input type="number" th:value="${order.price}" name="price" min="0" step="1">
    </div>

    <label>張り人</label>
    <div class="input-wrapper">
      <input type="text" th:value="${order.stringerName}" name="stringerName">
    </div>

    <label>納期</label>
    <div class="input-wrapper">
      <input type="date" th:value="${order.dueDate}" name="dueDate" required>
    </div>

    <label>ステータス</label>
    <div class="select-wrapper">
      <select name="status">
        <option value="未着手" th:selected="${order.status == '未着手'}">未着手</option>
        <option value="張り中" th:selected="${order.status == '張り中'}">張り中</option>
        <option value="完了" th:selected="${order.status == '完了'}">完了</option>
      </select>
    </div>

    <div class="form-buttons">
      <button type="submit">更新</button>
      <a th:href="@{/staff/orders}" class="back-btn">戻る</a>
    </div>
  </form>

  <!-- ✅ 顧客検索・サジェスト機能 -->
  <script>
    const searchInput = document.getElementById('customerSearch');
    const suggestList = document.getElementById('suggestList');
    const items = Array.from(suggestList.querySelectorAll('li'));
    const hiddenCustomerId = document.getElementById('selectedCustomerId');
    let currentIndex = -1;

    searchInput.addEventListener('focus', () => {
      suggestList.style.display = 'block';
    });

    searchInput.addEventListener('input', () => {
      const keyword = searchInput.value.toLowerCase();
      let matchCount = 0;
      items.forEach(li => {
        const visible = li.textContent.toLowerCase().includes(keyword);
        li.style.display = visible ? '' : 'none';
        if (visible) matchCount++;
      });
      suggestList.style.display = matchCount > 0 ? 'block' : 'none';
      currentIndex = -1;
    });

    items.forEach(li => {
      li.addEventListener('click', () => {
        searchInput.value = li.textContent;
        hiddenCustomerId.value = li.dataset.id;
        suggestList.style.display = 'none';
      });
    });

    document.addEventListener('click', (e) => {
      if (!suggestList.contains(e.target) && e.target !== searchInput) {
        suggestList.style.display = 'none';
      }
    });

    searchInput.addEventListener('keydown', (e) => {
      const visibleItems = items.filter(li => li.style.display !== 'none');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentIndex = Math.min(currentIndex + 1, visibleItems.length - 1);
        highlight(visibleItems[currentIndex]);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentIndex = Math.max(currentIndex - 1, 0);
        highlight(visibleItems[currentIndex]);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentIndex >= 0) {
          const li = visibleItems[currentIndex];
          searchInput.value = li.textContent;
          hiddenCustomerId.value = li.dataset.id;
          suggestList.style.display = 'none';
        }
      }
    });

    function highlight(target) {
      items.forEach(li => li.style.background = '');
      if (target) target.style.background = '#f5f8fc';
    }
  </script>
</body>
</html>
